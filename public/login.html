<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تسجيل الدخول - CourseHub</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/footer.css">
  <link rel="stylesheet" href="css/login.css">

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <!-- الهيدر سيتم تحميله تلقائياً -->
  <div id="header-placeholder"></div>

  <main class="login-page container">
    <h2>تسجيل الدخول</h2>

    <!-- Email Login Form -->
    <form id="loginForm" class="login-form">
      <label for="email">البريد الإلكتروني</label>
      <input type="email" id="email" name="email" placeholder="example@mail.com" autocomplete="email" required>

      <label for="password">كلمة المرور</label>
      <input type="password" id="password" name="password" placeholder="********" autocomplete="current-password" required>

      <button type="submit" class="btn">تسجيل الدخول</button>
      <div id="errorMsg" class="error-msg"></div>
    </form>

    <p class="divider">أو سجل الدخول بواسطة</p>

    <!-- Google Login -->
    <div id="g_id_onload"
         data-client_id="367073521017-na5sqgdpp98hqrd6us63l4117l4vbacm.apps.googleusercontent.com"
         data-callback="handleGoogleLogin"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large"></div>

    <div class="login-links">
      <p><a href="forgot-password.html">نسيت كلمة المرور؟</a></p>
      <p>ليس لديك حساب؟ <a href="register.html">إنشاء حساب</a></p>
    </div>
  </main>

  <!-- الفوتر سيتم تحميله تلقائياً -->
  <div id="footer-placeholder"></div>

  <!-- Firebase + Auth Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithCredential } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCagdZU_eAHebBGCmG5W4FFTcDZIH4wOp0",
      authDomain: "coursehub-23ed2.firebaseapp.com",
      projectId: "coursehub-23ed2",
      storageBucket: "coursehub-23ed2.firebasestorage.app",
      messagingSenderId: "367073521017",
      appId: "1:367073521017:web:67f5fd3be4c6407247d3a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ===== Helpers ===== */
    function saveUser(user) {
      localStorage.setItem("coursehub_user", JSON.stringify(user));
    }

    function redirectUser(role) {
      if(role === "admin") window.location.href = "admin/dashboard.html";
      else window.location.href = "courses.html";
    }

    /* ===== Email Login ===== */
    const form = document.getElementById("loginForm");
    const errorMsg = document.getElementById("errorMsg");

    if(form){
      form.addEventListener("submit", async e => {
        e.preventDefault();
        const emailInput = document.getElementById("email").value;
        const passwordInput = document.getElementById("password").value;

        try{
          const cred = await signInWithEmailAndPassword(auth, emailInput, passwordInput);
          const userRef = doc(db, "users", cred.user.uid);
          const snap = await getDoc(userRef);

          if(!snap.exists()) throw new Error("المستخدم غير موجود");

          saveUser(snap.data());
          redirectUser(snap.data().role);

        }catch(err){
          console.error(err);
          errorMsg.textContent = "بيانات الدخول غير صحيحة";
        }
      });
    }

    /* ===== Google Login ===== */
    window.handleGoogleLogin = async (res) => {
      try{
        const jwt = res.credential;
        const payload = JSON.parse(atob(jwt.split(".")[1]));
        const cred = GoogleAuthProvider.credential(jwt);
        const userCred = await signInWithCredential(auth, cred);

        const userRef = doc(db, "users", userCred.user.uid);
        const snap = await getDoc(userRef);

        let role = "student";
        if(!snap.exists()){
          await setDoc(userRef, {
            name: payload.name,
            email: payload.email,
            picture: payload.picture,
            role,
            createdAt: new Date()
          });
        } else {
          role = snap.data().role;
        }

        saveUser({...payload, role});
        redirectUser(role);

      }catch(err){
        console.error(err);
        alert("حدث خطأ أثناء تسجيل الدخول عبر Google");
      }
    };
  </script>

  <!-- تحميل الهيدر والفوتر -->
  <script type="module" src="js/main.js" defer></script>
</body>
</html>
